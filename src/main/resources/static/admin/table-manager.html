<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω b√†n ƒÉn</title>
    <link rel="stylesheet" href="css/table-manager.css">

</head>
<body>
<div class="header">
    <button class="menu-btn" onclick="toggleSidebar()">&#9776;</button>
    <h1>Qu·∫£n l√Ω b√†n ƒÉn</h1>
    <div class="user-info" id="userInfo"></div>
</div>

<div class="sidebar" id="sidebar">
  <button class="close-btn" onclick="toggleSidebar()">&#9776;</button>
  <a href="#" onclick="goToDashboard()">B·∫£ng ƒëi·ªÅu khi·ªÉn</a>
  <a href="#" onclick="goToCategories()">Qu·∫£n l√Ω danh m·ª•c</a>
  <a href="#" onclick="goToMenuItems()">Qu·∫£n l√Ω m√≥n ƒÉn</a>
  <a href="#" onclick="goToTables()">Qu·∫£n l√Ω b√†n</a>
  <a href="#" onclick="goToOrders()">Qu·∫£n l√Ω ƒë∆°n h√†ng</a>
</div>

<div id="adminActions" class="admin-actions" style="text-align: end; margin-right: 20px; display: none;">
        <button class="btn" onclick="showAddTable()" style=" font-size: 20px;">‚ûï Th√™m b√†n</button>
    </div>

<div class="table-grid" id="tableContainer"></div>


<!-- Modal cho chi ti·∫øt ƒë∆°n h√†ng -->
<div id="modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <h3>Chi ti·∫øt ƒë∆°n</h3>
        <div id="modalBody"></div>
    </div>
</div>
<!-- Modal cho th√™m b√†n m·ªõi -->
<div id="addTableModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-x" onclick="closeAddTableModal()">&times;</span> 
        <h3>Th√™m b√†n m·ªõi</h3>
        <div>
            <input type="number" id="newTableNumber" placeholder="Nh·∫≠p s·ªë b√†n" style="width: 100%; padding: 8px;"/>
            <input type="number" id="newTableCapacity" placeholder="Nh·∫≠p s·ª©c ch·ª©a" style="width: 100%; padding: 8px; margin-top: 8px;"/>
        </div>
        <div style="margin-top: 15px; text-align: right;">
            <button class="btn" onclick="submitNewTable()">L∆∞u</button>
        </div>
    </div>
</div>


<!-- WebSocket JS -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
    const BASE_URL = "http://192.168.1.9:8080";
    let currentOpenTableId = null;
    let stompClient = null;
    const previousOrders = {};
    const role = localStorage.getItem("role");

    function loadTables() {
        fetch(BASE_URL + "/api/tables")
            .then(res => res.json())
            .then(tables => {
                const container = document.getElementById('tableContainer');
                container.innerHTML = '';

                tables
                .sort((a, b) => parseInt(a.tableNumber) - parseInt(b.tableNumber))
                .forEach(table => {
                    const card = document.createElement('div');
                    card.className = 'table-card';

                    fetch(`${BASE_URL}/api/orders/table/${table.id}/current`)
                        .then(res => res.ok ? res.json() : null)
                        .then(order => {
                            card.innerHTML = `
                                <h3>B√†n ${table.tableNumber}</h3>
                                <p class="status">Tr·∫°ng th√°i: ${table.status}</p>
                                <p>T·ªïng ti·ªÅn: ${order ? order.totalAmount.toLocaleString('vi-VN') + ' VND' : '0 VND'}</p>
                                <button class="btn btn-detail" onclick="showDetails(${table.id})">Chi ti·∫øt</button>
                                ${order ? `<button class='btn btn-pay' onclick='pay(${order.id}, ${table.id})'>Thanh to√°n</button>` : ''}
                                ${role === 'MANAGER' ? `
                                    <button class="btn" onclick="showEditTable(${table.id}, ${table.tableNumber})">‚úèÔ∏è</button>
                                    <button class="btn" onclick="deleteTable(${table.id})">üóëÔ∏è</button>` : ''}
                            `;
                            container.appendChild(card);

                            if (order) {
                                const prev = previousOrders[table.id];
                                const itemCount = order.orderItems?.length || 0;

                                if (!prev || order.totalAmount !== prev.totalAmount || itemCount !== prev.itemCount) {
                                    highlightCard(card);
                                }

                                previousOrders[table.id] = {
                                    totalAmount: order.totalAmount,
                                    itemCount: itemCount
                                };
                            }
                        });
                })
                .catch(error => {
                    console.error("L·ªói khi t·∫£i ƒë∆°n h√†ng:", error);
                });
            });
    }

    function showAddTable() {
        document.getElementById("newTableNumber").value = "";
        document.getElementById("addTableModal").style.display = "flex";
    }

    function closeAddTableModal() {
        document.getElementById("addTableModal").style.display = "none";
    }

    async function submitNewTable() {
    const number = document.getElementById("newTableNumber").value.trim();
    const capacity = document.getElementById("newTableCapacity").value.trim();

    if (!number || !capacity) {
        alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß s·ªë b√†n v√† s·ª©c ch·ª©a!");
        return;
    }

    try {
        const response = await fetch(`${BASE_URL}/api/tables`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                qrCodeUrl: "",
                 tableNumber: String(number),
                status: "Tr·ªëng",
                capacity: capacity
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || "L·ªói khi th√™m b√†n m·ªõi!");
        }

        closeAddTableModal();
        loadTables();
    } catch (error) {
        console.error(error);
        alert("ƒê√£ x·∫£y ra l·ªói: " + error.message);
    }
}

    async function showEditTable(id, currentNumber) {
        const newNumber = prompt("Nh·∫≠p s·ªë b√†n m·ªõi:", currentNumber);
        if (!newNumber) return;

        try {
            const res = await fetch(`${BASE_URL}/api/tables/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ tableNumber: newNumber })
            });

            if (!res.ok) throw new Error("C·∫≠p nh·∫≠t s·ªë b√†n th·∫•t b·∫°i!");

            loadTables();
        } catch (error) {
            console.error(error);
            alert("L·ªói khi c·∫≠p nh·∫≠t b√†n: " + error.message);
        }
    }

    async function deleteTable(id) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√†n n√†y kh√¥ng?")) return;

        try {
            const res = await fetch(`${BASE_URL}/api/tables/${id}`, {
                method: "DELETE"
            });

            if (!res.ok) throw new Error("Kh√¥ng th·ªÉ x√≥a b√†n.");

            loadTables();
        } catch (error) {
            console.error(error);
            alert("L·ªói khi x√≥a b√†n: " + error.message);
        }
    }


    function highlightCard(cardElement) {
        cardElement.classList.add('highlight');
        setTimeout(() => {
            cardElement.classList.remove('highlight');
        }, 5000);
    }

    function showDetails(tableId) {
        currentOpenTableId = tableId;
        fetch(`${BASE_URL}/api/orders/table/${tableId}/current`)
            .then(res => res.json())
            .then(order => {
                const modalBody = document.getElementById("modalBody");
                modalBody.innerHTML = order.orderItems.map(item => `
                    <div class="order-item">
                        <strong>${item.menuItem.name} x${item.quantity}</strong>
                        ${item.notes ? `<div class="order-note">Ghi ch√∫: ${item.notes}</div>` : ''}
                        <div>
                            ${item.prepared 
                                ? `<span class="status-prepared">ƒê√£ l√†m</span>` 
                                : `<button class="btn-prepared" onclick="markPrepared(${item.id})">ƒê√£ xong</button>`}
                        </div>
                    </div>
                `).join('');
                document.getElementById("modal").style.display = "flex";
            });
    }

    function closeModal() {
        currentOpenTableId = null;
        document.getElementById("modal").style.display = "none";
    }

    function markPrepared(itemId) {
        fetch(`${BASE_URL}/api/orders/items/${itemId}/prepared`, { method: 'PUT' })
            .then(() => {
                if (currentOpenTableId) showDetails(currentOpenTableId);
            });
    }

    function pay(orderId, tableId) {
        const userId = localStorage.getItem("userId");
        if (!userId) {
            alert("Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c ng∆∞·ªùi d√πng!");
            return;
        }

        fetch(`${BASE_URL}/api/orders/${orderId}/pay?userId=${userId}`, { method: 'PUT' })
            .then(response => {
                if (!response.ok) throw new Error("L·ªói khi thanh to√°n");
                alert("Thanh to√°n th√†nh c√¥ng!");
                loadTables(); 
            })
            .catch(error => {
                console.error("L·ªói:", error);
                alert("Thanh to√°n th·∫•t b·∫°i: " + error.message);
            });
    }

    function connectWebSocket() {
        const socket = new SockJS(BASE_URL + "/ws");
        stompClient = Stomp.over(socket);
        stompClient.connect({}, () => {
            stompClient.subscribe("/topic/tables", () => {
                //console.log("Nh·∫≠n c·∫≠p nh·∫≠t WebSocket t·ª´ server");
                loadTables();
            });
        });
    }

    loadTables();
    connectWebSocket();

    const fullname = localStorage.getItem("fullname");
    if (fullname) {
        document.getElementById("userInfo").innerHTML = `
            <p style="color: white;">Xin ch√†o, <span style="color: white;">${fullname}</span></p>
            <a href="#" style="color: #00f; text-decoration: underline;" onclick="logout()">ƒêƒÉng xu·∫•t</a>
        `;
    }

    if (role === "MANAGER") {
        document.getElementById("adminActions").style.display = "block";
    } else {
        document.getElementById("adminActions").style.display = "none";
    }

    function logout() {
        localStorage.removeItem("fullname");
        localStorage.removeItem("role");
        window.location.href = "/login.html";
    }
</script>


</body>
</html>
