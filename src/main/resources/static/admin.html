<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω b√†n ƒÉn</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 1rem;
            background: #f9f9f9;
        }
        h1 {
            color: #333;
        }
        .table-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .table-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            padding: 1rem;
            position: relative;
        }
        .status {
            font-weight: bold;
        }
        .btn {
            margin-top: 0.5rem;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-detail {
            background-color: #3498db;
            color: white;
        }
        .btn-pay {
            background-color: #2ecc71;
            color: white;
            margin-left: 5px;
        }
        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>

<h1>Qu·∫£n l√Ω b√†n ƒÉn</h1>

<div class="table-grid" id="tableContainer">
    <!-- C√°c b√†n s·∫Ω ƒë∆∞·ª£c th√™m ·ªü ƒë√¢y -->
</div>

<div id="modal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Chi ti·∫øt ƒë∆°n</h3>
        <div id="modalBody"></div>
        <button onclick="closeModal()">ƒê√≥ng</button>
    </div>
</div>

<!-- WebSocket JS -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
const BASE_URL = "http://192.168.1.7:8080";
let currentOpenTableId = null;
let stompClient = null;

function loadTables() {
    fetch(BASE_URL + "/api/tables")
        .then(res => res.json())
        .then(tables => {
            const container = document.getElementById('tableContainer');
            container.innerHTML = '';

            tables.forEach(table => {
                const card = document.createElement('div');
                card.className = 'table-card';

                fetch(`${BASE_URL}/api/orders/table/${table.id}/current`)
                    .then(res => res.ok ? res.json() : null)
                    .then(order => {
                        card.innerHTML = `
                            <h3>B√†n ${table.tableNumber}</h3>
                            <p class="status">Tr·∫°ng th√°i: ${table.status}</p>
                            <p>T·ªïng ti·ªÅn: ${order ? order.totalAmount.toLocaleString('vi-VN') + ' VND' : '0 VND'}</p>
                            <button class="btn btn-detail" onclick="showDetails(${table.id})">Chi ti·∫øt</button>
                            ${order ? `<button class='btn btn-pay' onclick='pay(${order.id}, ${table.id})'>Thanh to√°n</button>` : ''}
                        `;
                        container.appendChild(card);
                    });
            });
        });
}

function showDetails(tableId) {
    currentOpenTableId = tableId;
    fetch(`${BASE_URL}/api/orders/table/${tableId}/current`)
        .then(res => res.json())
        .then(order => {
            const modalBody = document.getElementById("modalBody");
            modalBody.innerHTML = order.orderItems.map(item => `
                <div style="margin-bottom: 8px;">
                    <strong>${item.menuItem.name}</strong> x${item.quantity}
                    ${item.notes ? `<div style="font-style: italic; color: #555;">üìù Ghi ch√∫: ${item.notes}</div>` : ''}
                    <div style="margin-top: 4px;">
                        ${item.prepared ? '‚úÖ <span style="color: green;">ƒê√£ l√†m</span>' : `<button onclick="markPrepared(${item.id})">ƒê√£ xong</button>`}
                    </div>
                </div>
            `).join('');
            document.getElementById("modal").style.display = "flex";
        });
}

function closeModal() {
    currentOpenTableId = null;
    document.getElementById("modal").style.display = "none";
}

function markPrepared(itemId) {
    fetch(`${BASE_URL}/api/orders/items/${itemId}/prepared`, { method: 'PUT' })
        .then(() => {
            if (currentOpenTableId) showDetails(currentOpenTableId);
        });
}

function pay(orderId, tableId) {
    fetch(`${BASE_URL}/api/orders/${orderId}/pay`, { method: 'PUT' });
}

function connectWebSocket() {
    const socket = new SockJS(BASE_URL + "/ws");
    stompClient = Stomp.over(socket);
    stompClient.connect({}, () => {
        stompClient.subscribe("/topic/tables", () => {
            console.log("üîÑ Nh·∫≠n c·∫≠p nh·∫≠t WebSocket t·ª´ server");
            loadTables();
        });
    });
}

loadTables();
connectWebSocket();
</script>

</body>
</html>
