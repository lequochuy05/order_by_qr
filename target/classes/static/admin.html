<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản lý bàn ăn</title>
    <style>
    body {
        font-family: Arial, sans-serif;
        padding: 1rem;
        background: #f9f9f9;
    }

    h1 {
        color: #333;
    }

    .table-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .table-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        padding: 1rem;
    }

    .status {
        font-weight: bold;
    }

    .btn {
        margin-top: 0.5rem;
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-detail {
        background-color: #3498db;
        color: white;
    }

    .btn-pay {
        background-color: #2ecc71;
        color: white;
        margin-left: 5px;
    }

    .modal {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .modal-content h3 {
        text-align: center;
        font-size: 20px;
        margin-bottom: 16px;
        color: #333;
    }

    .modal-content {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        width: 400px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    .order-item {
        background-color: #f2f2f2;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 10px;
        border-left: 4px solid #3498db;
    }

    .order-item strong {
        font-size: 16px;
        display: block;
        margin-bottom: 4px;
    }

    .order-note {
        font-style: italic;
        color: #666;
        font-size: 14px;
        margin-bottom: 6px;
    }

    .btn-prepared {
        background-color: #e0f7e9;
        color: #e92020;
        border: 1px solid #2ecc71;
        font-size: 14px;
        padding: 5px 8px;
        border-radius: 4px;
        cursor: pointer;
    }

    .status-prepared {
        color: #27ae60;
        font-weight: bold;
    }

    
    .btn-close {
        background-color: #e74c3c;
        color: white;
        padding: 8px 16px;
        margin-top: 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        display: block;
        margin-left: auto;
        margin-right: auto;
    }
</style>

</head>
<body>

<h1>Quản lý bàn ăn</h1>

<div class="table-grid" id="tableContainer">
    <!-- Các bàn sẽ được thêm ở đây -->
</div>

<div id="modal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Chi tiết đơn</h3>
        <div id="modalBody"></div>
        <button class="btn-close" onclick="closeModal()">Đóng</button>
    </div>
</div>

<!-- WebSocket JS -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
const BASE_URL = "http://192.168.1.9:8080";
let currentOpenTableId = null;
let stompClient = null;

function loadTables() {
    fetch(BASE_URL + "/api/tables")
    .then(res => res.json())
    .then(tables => {
        const container = document.getElementById('tableContainer');
        container.innerHTML = '';

        tables
          .sort((a, b) => parseInt(a.tableNumber) - parseInt(b.tableNumber))
          .forEach(table => {
            const card = document.createElement('div');
            card.className = 'table-card';

            fetch(`${BASE_URL}/api/orders/table/${table.id}/current`)
                .then(res => res.ok ? res.json() : null)
                .then(order => {
                    card.innerHTML = `
                        <h3>Bàn ${table.tableNumber}</h3>
                        <p class="status">Trạng thái: ${table.status}</p>
                        <p>Tổng tiền: ${order ? order.totalAmount.toLocaleString('vi-VN') + ' VND' : '0 VND'}</p>
                        <button class="btn btn-detail" onclick="showDetails(${table.id})">Chi tiết</button>
                        ${order ? `<button class='btn btn-pay' onclick='pay(${order.id}, ${table.id})'>Thanh toán</button>` : ''}
                    `;
                    container.appendChild(card);
                });
        });
    });

}

function showDetails(tableId) {
    currentOpenTableId = tableId;
    fetch(`${BASE_URL}/api/orders/table/${tableId}/current`)
        .then(res => res.json())
        .then(order => {
            const modalBody = document.getElementById("modalBody");
            modalBody.innerHTML = order.orderItems.map(item => `
                <div class="order-item">
                    <strong>${item.menuItem.name} x${item.quantity}</strong>
                    ${item.notes ? `<div class="order-note">Ghi chú: ${item.notes}</div>` : ''}
                    <div>
                        ${item.prepared 
                            ? `<span class="status-prepared">Đã làm</span>` 
                            : `<button class="btn-prepared" onclick="markPrepared(${item.id})">Đã xong</button>`}
                    </div>
                </div>
            `).join('');
            document.getElementById("modal").style.display = "flex";
        });
}

function closeModal() {
    currentOpenTableId = null;
    document.getElementById("modal").style.display = "none";
}

function markPrepared(itemId) {
    fetch(`${BASE_URL}/api/orders/items/${itemId}/prepared`, { method: 'PUT' })
        .then(() => {
            if (currentOpenTableId) showDetails(currentOpenTableId);
        });
}

function pay(orderId, tableId) {
    fetch(`${BASE_URL}/api/orders/${orderId}/pay`, { method: 'PUT' });
}

function connectWebSocket() {
    const socket = new SockJS(BASE_URL + "/ws");
    stompClient = Stomp.over(socket);
    stompClient.connect({}, () => {
        stompClient.subscribe("/topic/tables", () => {
            console.log("Nhận cập nhật WebSocket từ server");
            loadTables();
        });
    });
}

loadTables();
connectWebSocket();
</script>

</body>
</html>
